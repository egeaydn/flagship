{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tr/Desktop/flagship/apps/dashboard/lib/firebase.ts"],"sourcesContent":["import { initializeApp, getApps } from 'firebase/app';\r\nimport { getAuth } from 'firebase/auth';\r\nimport { getFirestore } from 'firebase/firestore';\r\n\r\nconst firebaseConfig = {\r\n  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,\r\n  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,\r\n  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,\r\n  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\r\n  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,\r\n  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,\r\n};\r\n\r\n// Initialize Firebase (singleton pattern)\r\nconst app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];\r\n\r\nexport const auth = getAuth(app);\r\nexport const db = getFirestore(app);\r\nexport default app;\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;AACA;AAAA;AACA;AAAA;;;;AAEA,MAAM,iBAAiB;IACrB,MAAM;IACN,UAAU;IACV,SAAS;IACT,aAAa;IACb,iBAAiB;IACjB,KAAK;AACP;AAEA,0CAA0C;AAC1C,MAAM,MAAM,IAAA,oMAAO,IAAG,MAAM,KAAK,IAAI,IAAA,0MAAa,EAAC,kBAAkB,IAAA,oMAAO,GAAE,CAAC,EAAE;AAE1E,MAAM,OAAO,IAAA,sMAAO,EAAC;AACrB,MAAM,KAAK,IAAA,0MAAY,EAAC;uCAChB"}},
    {"offset": {"line": 164, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tr/Desktop/flagship/apps/dashboard/lib/firestore.ts"],"sourcesContent":["import { \r\n  collection, \r\n  addDoc, \r\n  serverTimestamp, \r\n  doc, \r\n  setDoc,\r\n  query,\r\n  where,\r\n  getDocs\r\n} from 'firebase/firestore';\r\nimport { db } from './firebase';\r\n\r\n// Collection names\r\nexport const COLLECTIONS = {\r\n  ORGANIZATIONS: 'organizations',\r\n  ORGANIZATION_MEMBERS: 'organization_members',\r\n  PROJECTS: 'projects',\r\n  ENVIRONMENTS: 'environments',\r\n  FEATURE_FLAGS: 'feature_flags',\r\n  FLAG_VALUES: 'flag_values',\r\n  API_KEYS: 'api_keys',\r\n  AUDIT_LOGS: 'audit_logs',\r\n  FLAG_ANALYTICS: 'flag_analytics',\r\n} as const;\r\n\r\n// Organization functions\r\nexport async function createOrganization(data: {\r\n  name: string;\r\n  slug: string;\r\n  createdBy: string;\r\n}) {\r\n  const orgRef = await addDoc(collection(db, COLLECTIONS.ORGANIZATIONS), {\r\n    ...data,\r\n    createdAt: serverTimestamp(),\r\n    updatedAt: serverTimestamp(),\r\n  });\r\n\r\n  // Auto-create owner membership\r\n  await setDoc(doc(db, COLLECTIONS.ORGANIZATION_MEMBERS, `${data.createdBy}_${orgRef.id}`), {\r\n    organizationId: orgRef.id,\r\n    userId: data.createdBy,\r\n    role: 'owner',\r\n    createdAt: serverTimestamp(),\r\n  });\r\n\r\n  return orgRef.id;\r\n}\r\n\r\nexport async function getUserOrganizations(userId: string) {\r\n  const membersQuery = query(\r\n    collection(db, COLLECTIONS.ORGANIZATION_MEMBERS),\r\n    where('userId', '==', userId)\r\n  );\r\n  \r\n  const membersSnap = await getDocs(membersQuery);\r\n  const orgIds = membersSnap.docs.map(doc => doc.data().organizationId);\r\n  \r\n  if (orgIds.length === 0) return [];\r\n  \r\n  const orgsQuery = query(\r\n    collection(db, COLLECTIONS.ORGANIZATIONS),\r\n    where('__name__', 'in', orgIds)\r\n  );\r\n  \r\n  const orgsSnap = await getDocs(orgsQuery);\r\n  return orgsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n}\r\n\r\n// Project functions\r\nexport async function createProject(data: {\r\n  organizationId: string;\r\n  name: string;\r\n  key: string;\r\n  description?: string;\r\n  createdBy: string;\r\n}) {\r\n  const projectRef = await addDoc(collection(db, COLLECTIONS.PROJECTS), {\r\n    ...data,\r\n    createdAt: serverTimestamp(),\r\n    updatedAt: serverTimestamp(),\r\n  });\r\n\r\n  // Auto-create default environments\r\n  const environments = [\r\n    { name: 'Development', key: 'dev' },\r\n    { name: 'Staging', key: 'staging' },\r\n    { name: 'Production', key: 'prod' },\r\n  ];\r\n\r\n  for (const env of environments) {\r\n    await addDoc(collection(db, COLLECTIONS.ENVIRONMENTS), {\r\n      projectId: projectRef.id,\r\n      ...env,\r\n      createdAt: serverTimestamp(),\r\n      updatedAt: serverTimestamp(),\r\n    });\r\n  }\r\n\r\n  return projectRef.id;\r\n}\r\n\r\n// Feature flag functions\r\nexport async function createFeatureFlag(data: {\r\n  projectId: string;\r\n  name: string;\r\n  key: string;\r\n  description?: string;\r\n  flagType: 'boolean' | 'multivariate' | 'number' | 'json';\r\n  defaultValue: any;\r\n  tags?: string[];\r\n  createdBy: string;\r\n}) {\r\n  // Create the flag\r\n  const flagRef = await addDoc(collection(db, COLLECTIONS.FEATURE_FLAGS), {\r\n    ...data,\r\n    tags: data.tags || [],\r\n    createdAt: serverTimestamp(),\r\n    updatedAt: serverTimestamp(),\r\n  });\r\n\r\n  // Get all environments for this project\r\n  const envsQuery = query(\r\n    collection(db, COLLECTIONS.ENVIRONMENTS),\r\n    where('projectId', '==', data.projectId)\r\n  );\r\n  const envsSnap = await getDocs(envsQuery);\r\n\r\n  // Create flag_values for each environment\r\n  for (const envDoc of envsSnap.docs) {\r\n    await addDoc(collection(db, COLLECTIONS.FLAG_VALUES), {\r\n      flagId: flagRef.id,\r\n      environmentId: envDoc.id,\r\n      enabled: false,\r\n      value: data.defaultValue,\r\n      updatedAt: serverTimestamp(),\r\n    });\r\n  }\r\n\r\n  return flagRef;\r\n}\r\n\r\n// API Key functions\r\nexport async function createApiKey(data: {\r\n  environmentId: string;\r\n  name: string;\r\n  keyType: 'client' | 'server';\r\n  createdBy: string;\r\n}) {\r\n  const bcrypt = (await import('bcryptjs')).default;\r\n  \r\n  // Generate random key: fsk_{type}_{32-char-random}\r\n  const randomPart = Array.from(crypto.getRandomValues(new Uint8Array(16)))\r\n    .map(b => b.toString(16).padStart(2, '0'))\r\n    .join('');\r\n  const rawKey = `fsk_${data.keyType}_${randomPart}`;\r\n  \r\n  // Hash for storage\r\n  const keyHash = await bcrypt.hash(rawKey, 10);\r\n  \r\n  // Prefix for quick lookup (first 12 chars)\r\n  const keyPrefix = rawKey.substring(0, 12);\r\n  \r\n  // Store in Firestore\r\n  await addDoc(collection(db, COLLECTIONS.API_KEYS), {\r\n    environmentId: data.environmentId,\r\n    name: data.name,\r\n    keyPrefix,\r\n    keyHash,\r\n    keyType: data.keyType,\r\n    revoked: false,\r\n    lastUsedAt: null,\r\n    createdAt: serverTimestamp(),\r\n    createdBy: data.createdBy,\r\n  });\r\n  \r\n  // Return raw key (shown ONCE)\r\n  return rawKey;\r\n}\r\n\r\nexport async function revokeApiKey(keyId: string) {\r\n  const keyRef = doc(db, COLLECTIONS.API_KEYS, keyId);\r\n  await updateDoc(keyRef, {\r\n    revoked: true,\r\n    updatedAt: serverTimestamp(),\r\n  });\r\n}\r\n\r\nexport async function getEnvironmentApiKeys(environmentId: string) {\r\n  const q = query(\r\n    collection(db, COLLECTIONS.API_KEYS),\r\n    where('environmentId', '==', environmentId),\r\n    where('revoked', '==', false)\r\n  );\r\n  const snapshot = await getDocs(q);\r\n  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n}\r\n\r\n// Audit Log functions (enhanced)\r\nexport async function createAuditLog(data: {\r\n  organizationId?: string;\r\n  projectId?: string;\r\n  environmentId?: string;\r\n  userId: string;\r\n  userEmail?: string;\r\n  action: string;\r\n  targetType?: string;  // kept for backward compatibility\r\n  resourceType: string;\r\n  resourceId: string;\r\n  resourceName?: string;\r\n  changes?: {\r\n    before?: any;\r\n    after?: any;\r\n  };\r\n  metadata?: Record<string, any>;\r\n  ipAddress?: string;\r\n  userAgent?: string;\r\n}) {\r\n  return await addDoc(collection(db, COLLECTIONS.AUDIT_LOGS), {\r\n    ...data,\r\n    timestamp: serverTimestamp(),\r\n    createdAt: serverTimestamp(),\r\n  });\r\n}\r\n\r\nexport async function getAuditLogs(organizationId: string, limit: number = 100) {\r\n  const logsQuery = query(\r\n    collection(db, COLLECTIONS.AUDIT_LOGS),\r\n    where('organizationId', '==', organizationId)\r\n  );\r\n  \r\n  const snapshot = await getDocs(logsQuery);\r\n  const logs = snapshot.docs.map(doc => ({ \r\n    id: doc.id, \r\n    ...doc.data() \r\n  }));\r\n  \r\n  // Sort by timestamp descending (newest first)\r\n  return logs.sort((a: any, b: any) => {\r\n    const aTime = a.timestamp?.toMillis() || a.createdAt?.toMillis() || 0;\r\n    const bTime = b.timestamp?.toMillis() || b.createdAt?.toMillis() || 0;\r\n    return bTime - aTime;\r\n  }).slice(0, limit);\r\n}\r\n\r\n// Analytics functions\r\nexport async function recordFlagEvaluation(data: {\r\n  flagKey: string;\r\n  flagId: string;\r\n  projectId: string;\r\n  environmentId: string;\r\n  userId?: string;\r\n  result: boolean | string | number;\r\n  targetingApplied?: boolean;\r\n}) {\r\n  return await addDoc(collection(db, COLLECTIONS.FLAG_ANALYTICS), {\r\n    ...data,\r\n    timestamp: serverTimestamp(),\r\n    createdAt: serverTimestamp(),\r\n  });\r\n}\r\n\r\nexport async function getFlagAnalytics(projectId: string, environmentId: string, days: number = 7) {\r\n  const analyticsQuery = query(\r\n    collection(db, COLLECTIONS.FLAG_ANALYTICS),\r\n    where('projectId', '==', projectId),\r\n    where('environmentId', '==', environmentId)\r\n  );\r\n  \r\n  const snapshot = await getDocs(analyticsQuery);\r\n  const analytics = snapshot.docs.map(doc => ({ \r\n    id: doc.id, \r\n    ...doc.data() \r\n  }));\r\n  \r\n  // Filter by date range (last N days)\r\n  const cutoffTime = Date.now() - (days * 24 * 60 * 60 * 1000);\r\n  \r\n  return analytics.filter((a: any) => {\r\n    const time = a.timestamp?.toMillis() || a.createdAt?.toMillis() || 0;\r\n    return time >= cutoffTime;\r\n  });\r\n}\r\n\r\nexport async function getAggregatedAnalytics(projectId: string, environmentId: string, days: number = 7) {\r\n  const analytics = await getFlagAnalytics(projectId, environmentId, days);\r\n  \r\n  // Aggregate by flag\r\n  const aggregated: Record<string, any> = {};\r\n  \r\n  analytics.forEach((entry: any) => {\r\n    const key = entry.flagKey;\r\n    \r\n    if (!aggregated[key]) {\r\n      aggregated[key] = {\r\n        flagKey: key,\r\n        flagId: entry.flagId,\r\n        evaluations: 0,\r\n        uniqueUsers: new Set(),\r\n        trueCount: 0,\r\n        falseCount: 0,\r\n        targetingAppliedCount: 0,\r\n      };\r\n    }\r\n    \r\n    aggregated[key].evaluations++;\r\n    \r\n    if (entry.userId) {\r\n      aggregated[key].uniqueUsers.add(entry.userId);\r\n    }\r\n    \r\n    if (entry.result === true) aggregated[key].trueCount++;\r\n    if (entry.result === false) aggregated[key].falseCount++;\r\n    if (entry.targetingApplied) aggregated[key].targetingAppliedCount++;\r\n  });\r\n  \r\n  // Convert Set to count\r\n  return Object.values(aggregated).map((item: any) => ({\r\n    ...item,\r\n    uniqueUsers: item.uniqueUsers.size,\r\n  }));\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 405, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tr/Desktop/flagship/apps/dashboard/lib/targeting.ts"],"sourcesContent":["// Targeting Rule Types\r\nexport interface TargetingCondition {\r\n  attribute: string; // User attribute to check (e.g., \"email\", \"plan\", \"country\")\r\n  operator: 'eq' | 'ne' | 'contains' | 'in' | 'gt' | 'lt' | 'gte' | 'lte';\r\n  value: any;\r\n}\r\n\r\nexport interface TargetingRule {\r\n  id: string;\r\n  description: string;\r\n  conditions: TargetingCondition[]; // AND logic - all conditions must match\r\n  rolloutPercentage: number; // 0-100\r\n  value: any; // Value to return if rule matches\r\n  enabled: boolean;\r\n}\r\n\r\nexport interface Targeting {\r\n  enabled: boolean;\r\n  rules: TargetingRule[]; // Evaluated in order\r\n  defaultRule: {\r\n    rolloutPercentage: number;\r\n    value: any;\r\n  };\r\n}\r\n\r\nexport interface UserContext {\r\n  id?: string;\r\n  attributes?: Record<string, any>;\r\n}\r\n\r\n// Hash function for consistent percentage rollout\r\nfunction hashString(str: string): number {\r\n  let hash = 0;\r\n  for (let i = 0; i < str.length; i++) {\r\n    const char = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + char;\r\n    hash = hash & hash; // Convert to 32bit integer\r\n  }\r\n  return Math.abs(hash);\r\n}\r\n\r\n// Check if user falls within rollout percentage\r\nfunction isInRollout(userId: string, flagKey: string, percentage: number): boolean {\r\n  if (percentage === 0) return false;\r\n  if (percentage === 100) return true;\r\n\r\n  const combinedStr = `${flagKey}:${userId}`;\r\n  const hash = hashString(combinedStr);\r\n  const bucket = hash % 100;\r\n  \r\n  return bucket < percentage;\r\n}\r\n\r\n// Evaluate a single condition\r\nfunction evaluateCondition(condition: TargetingCondition, user: UserContext): boolean {\r\n  const userValue = user.attributes?.[condition.attribute];\r\n  \r\n  if (userValue === undefined) {\r\n    return false;\r\n  }\r\n\r\n  switch (condition.operator) {\r\n    case 'eq':\r\n      return userValue === condition.value;\r\n    \r\n    case 'ne':\r\n      return userValue !== condition.value;\r\n    \r\n    case 'contains':\r\n      return String(userValue).includes(String(condition.value));\r\n    \r\n    case 'in':\r\n      return Array.isArray(condition.value) && condition.value.includes(userValue);\r\n    \r\n    case 'gt':\r\n      return Number(userValue) > Number(condition.value);\r\n    \r\n    case 'lt':\r\n      return Number(userValue) < Number(condition.value);\r\n    \r\n    case 'gte':\r\n      return Number(userValue) >= Number(condition.value);\r\n    \r\n    case 'lte':\r\n      return Number(userValue) <= Number(condition.value);\r\n    \r\n    default:\r\n      return false;\r\n  }\r\n}\r\n\r\n// Evaluate a targeting rule (all conditions must match - AND logic)\r\nfunction evaluateRule(rule: TargetingRule, user: UserContext, flagKey: string): { matches: boolean; value: any } {\r\n  if (!rule.enabled) {\r\n    return { matches: false, value: undefined };\r\n  }\r\n\r\n  // Check all conditions\r\n  const allConditionsMatch = rule.conditions.every(condition => \r\n    evaluateCondition(condition, user)\r\n  );\r\n\r\n  if (!allConditionsMatch) {\r\n    return { matches: false, value: undefined };\r\n  }\r\n\r\n  // Conditions matched, now check rollout percentage\r\n  if (!user.id) {\r\n    // No user ID, use random rollout\r\n    const randomBucket = Math.floor(Math.random() * 100);\r\n    return {\r\n      matches: randomBucket < rule.rolloutPercentage,\r\n      value: rule.value\r\n    };\r\n  }\r\n\r\n  const inRollout = isInRollout(user.id, flagKey, rule.rolloutPercentage);\r\n  return {\r\n    matches: inRollout,\r\n    value: rule.value\r\n  };\r\n}\r\n\r\n// Main evaluation function\r\nexport function evaluateTargeting(\r\n  flagKey: string,\r\n  targeting: Targeting | undefined,\r\n  user: UserContext,\r\n  defaultValue: any\r\n): { enabled: boolean; value: any } {\r\n  // If targeting is not configured or disabled, return default\r\n  if (!targeting || !targeting.enabled) {\r\n    return { enabled: true, value: defaultValue };\r\n  }\r\n\r\n  // Evaluate rules in order\r\n  for (const rule of targeting.rules) {\r\n    const result = evaluateRule(rule, user, flagKey);\r\n    if (result.matches) {\r\n      return { enabled: true, value: result.value };\r\n    }\r\n  }\r\n\r\n  // No rules matched, use default rule\r\n  const userId = user.id || `anon-${Math.random()}`;\r\n  const inDefaultRollout = isInRollout(userId, flagKey, targeting.defaultRule.rolloutPercentage);\r\n  \r\n  return {\r\n    enabled: inDefaultRollout,\r\n    value: targeting.defaultRule.value\r\n  };\r\n}\r\n\r\n// Helper: Create a simple percentage rollout targeting\r\nexport function createPercentageRollout(percentage: number, value: any): Targeting {\r\n  return {\r\n    enabled: true,\r\n    rules: [],\r\n    defaultRule: {\r\n      rolloutPercentage: percentage,\r\n      value: value\r\n    }\r\n  };\r\n}\r\n\r\n// Helper: Create attribute-based targeting\r\nexport function createAttributeTargeting(\r\n  attribute: string,\r\n  operator: TargetingCondition['operator'],\r\n  value: any,\r\n  targetValue: any\r\n): Targeting {\r\n  return {\r\n    enabled: true,\r\n    rules: [\r\n      {\r\n        id: `${attribute}-rule`,\r\n        description: `Users where ${attribute} ${operator} ${value}`,\r\n        conditions: [\r\n          {\r\n            attribute,\r\n            operator,\r\n            value\r\n          }\r\n        ],\r\n        rolloutPercentage: 100,\r\n        value: targetValue,\r\n        enabled: true\r\n      }\r\n    ],\r\n    defaultRule: {\r\n      rolloutPercentage: 0,\r\n      value: false\r\n    }\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 556, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tr/Desktop/flagship/apps/dashboard/app/api/v1/flags/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { db } from '@/lib/firebase';\r\nimport { collection, query, where, getDocs, doc, updateDoc } from 'firebase/firestore';\r\nimport { COLLECTIONS, recordFlagEvaluation } from '@/lib/firestore';\r\nimport { evaluateTargeting, UserContext } from '@/lib/targeting';\r\n\r\n// Request schema validation\r\nconst requestSchema = z.object({\r\n  user: z.object({\r\n    id: z.string().optional(),\r\n    attributes: z.record(z.string(), z.any()).optional(),\r\n  }).optional(),\r\n});\r\n\r\n// API key authentication\r\nasync function authenticateApiKey(apiKey: string | null) {\r\n  if (!apiKey) {\r\n    return { valid: false, environmentId: null };\r\n  }\r\n\r\n  const bcrypt = (await import('bcryptjs')).default;\r\n  \r\n  // Extract prefix (first 12 chars)\r\n  const prefix = apiKey.substring(0, 12);\r\n  \r\n  // Find key by prefix\r\n  const keysQuery = query(\r\n    collection(db, COLLECTIONS.API_KEYS),\r\n    where('keyPrefix', '==', prefix),\r\n    where('revoked', '==', false)\r\n  );\r\n  \r\n  const keysSnapshot = await getDocs(keysQuery);\r\n  \r\n  for (const keyDoc of keysSnapshot.docs) {\r\n    const keyData = keyDoc.data();\r\n    \r\n    // Verify hash\r\n    const isValid = await bcrypt.compare(apiKey, keyData.keyHash);\r\n    \r\n    if (isValid) {\r\n      // TODO: Update last used timestamp (requires Admin SDK)\r\n      // await updateDoc(doc(db, COLLECTIONS.API_KEYS, keyDoc.id), {\r\n      //   lastUsedAt: new Date(),\r\n      // });\r\n      \r\n      return {\r\n        valid: true,\r\n        environmentId: keyData.environmentId,\r\n        keyType: keyData.keyType,\r\n      };\r\n    }\r\n  }\r\n  \r\n  return { valid: false, environmentId: null };\r\n}\r\n\r\n// Get project from environment\r\nasync function getProjectFromEnvironment(environmentId: string) {\r\n  const envsQuery = query(\r\n    collection(db, COLLECTIONS.ENVIRONMENTS)\r\n  );\r\n  const envSnapshot = await getDocs(envsQuery);\r\n  \r\n  const envDoc = envSnapshot.docs.find(doc => doc.id === environmentId);\r\n  \r\n  if (!envDoc) return null;\r\n  \r\n  return envDoc.data().projectId;\r\n}\r\n\r\n// Fetch flags for project with targeting evaluation\r\nasync function getProjectFlags(projectId: string, environmentId: string, user?: UserContext) {\r\n  // Get all flags for project\r\n  const flagsQuery = query(\r\n    collection(db, COLLECTIONS.FEATURE_FLAGS),\r\n    where('projectId', '==', projectId)\r\n  );\r\n  const flagsSnapshot = await getDocs(flagsQuery);\r\n  \r\n  // Get flag values for environment\r\n  const valuesQuery = query(\r\n    collection(db, COLLECTIONS.FLAG_VALUES),\r\n    where('environmentId', '==', environmentId)\r\n  );\r\n  const valuesSnapshot = await getDocs(valuesQuery);\r\n  \r\n  const flagValues = new Map();\r\n  valuesSnapshot.docs.forEach(doc => {\r\n    const data = doc.data();\r\n    flagValues.set(data.flagId, data);\r\n  });\r\n  \r\n  // Combine flags with values and evaluate targeting\r\n  const flags: Record<string, any> = {};\r\n  \r\n  flagsSnapshot.docs.forEach(doc => {\r\n    const flagData = doc.data();\r\n    const flagValue = flagValues.get(doc.id);\r\n    \r\n    if (flagValue) {\r\n      // Evaluate targeting rules if present\r\n      const targeting = flagValue.targeting;\r\n      let targetingApplied = false;\r\n      \r\n      if (targeting && targeting.enabled && user) {\r\n        const result = evaluateTargeting(\r\n          flagData.key,\r\n          targeting,\r\n          user,\r\n          flagValue.value\r\n        );\r\n        \r\n        targetingApplied = true;\r\n        \r\n        flags[flagData.key] = {\r\n          enabled: result.enabled,\r\n          value: result.value,\r\n          type: flagData.flagType,\r\n          _analytics: {\r\n            flagId: doc.id,\r\n            targetingApplied,\r\n          },\r\n        };\r\n        \r\n        // Record analytics (async, don't await to avoid slowing down response)\r\n        recordFlagEvaluation({\r\n          flagKey: flagData.key,\r\n          flagId: doc.id,\r\n          projectId,\r\n          environmentId,\r\n          userId: user.id,\r\n          result: result.enabled,\r\n          targetingApplied,\r\n        }).catch(err => console.error('Analytics error:', err));\r\n        \r\n      } else {\r\n        // No targeting or targeting disabled\r\n        flags[flagData.key] = {\r\n          enabled: flagValue.enabled || false,\r\n          value: flagValue.value,\r\n          type: flagData.flagType,\r\n          _analytics: {\r\n            flagId: doc.id,\r\n            targetingApplied,\r\n          },\r\n        };\r\n        \r\n        // Record analytics\r\n        recordFlagEvaluation({\r\n          flagKey: flagData.key,\r\n          flagId: doc.id,\r\n          projectId,\r\n          environmentId,\r\n          userId: user?.id,\r\n          result: flagValue.enabled || false,\r\n          targetingApplied,\r\n        }).catch(err => console.error('Analytics error:', err));\r\n      }\r\n    } else {\r\n      // Default values if no flag_value exists\r\n      flags[flagData.key] = {\r\n        enabled: false,\r\n        value: flagData.defaultValue,\r\n        type: flagData.flagType,\r\n        _analytics: {\r\n          flagId: doc.id,\r\n          targetingApplied: false,\r\n        },\r\n      };\r\n      \r\n      // Record analytics for default values too\r\n      recordFlagEvaluation({\r\n        flagKey: flagData.key,\r\n        flagId: doc.id,\r\n        projectId,\r\n        environmentId,\r\n        userId: user?.id,\r\n        result: false,\r\n        targetingApplied: false,\r\n      }).catch(err => console.error('Analytics error:', err));\r\n    }\r\n  });\r\n  \r\n  return flags;\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Extract API key from header\r\n    const apiKey = request.headers.get('x-api-key') || \r\n                   request.headers.get('authorization')?.replace('Bearer ', '');\r\n    \r\n    // Authenticate\r\n    const auth = await authenticateApiKey(apiKey);\r\n    \r\n    if (!auth.valid) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid or missing API key' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n    \r\n    // Parse request body\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      body = {};\r\n    }\r\n    \r\n    // Validate request\r\n    const validation = requestSchema.safeParse(body);\r\n    if (!validation.success) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid request body', details: validation.error },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    \r\n    // Get project from environment\r\n    const projectId = await getProjectFromEnvironment(auth.environmentId!);\r\n    \r\n    if (!projectId) {\r\n      return NextResponse.json(\r\n        { error: 'Environment not found' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n    \r\n    // Fetch flags with targeting evaluation\r\n    const flags = await getProjectFlags(\r\n      projectId, \r\n      auth.environmentId!,\r\n      validation.data.user\r\n    );\r\n    \r\n    // Return response\r\n    return NextResponse.json(\r\n      {\r\n        flags,\r\n        user: validation.data.user,\r\n      },\r\n      {\r\n        status: 200,\r\n        headers: {\r\n          'Access-Control-Allow-Origin': '*',\r\n          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n          'Access-Control-Allow-Headers': 'Content-Type, x-api-key',\r\n          'Cache-Control': 'public, max-age=60, s-maxage=60',\r\n          'Content-Type': 'application/json',\r\n        },\r\n      }\r\n    );\r\n    \r\n  } catch (error: any) {\r\n    console.error('API Error:', error);\r\n    \r\n    return NextResponse.json(\r\n      { error: 'Internal server error', message: error.message },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// OPTIONS method for CORS preflight\r\nexport async function OPTIONS() {\r\n  return new NextResponse(null, {\r\n    status: 200,\r\n    headers: {\r\n      'Access-Control-Allow-Origin': '*',\r\n      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n      'Access-Control-Allow-Headers': 'Content-Type, x-api-key',\r\n    },\r\n  });\r\n}\r\n\r\n// GET method for health check\r\nexport async function GET() {\r\n  return NextResponse.json(\r\n    {\r\n      service: 'Flagship Feature Flags API',\r\n      version: '1.0.0',\r\n      status: 'operational',\r\n    },\r\n    {\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n      },\r\n    }\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}