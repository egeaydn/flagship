{"version":3,"sources":["../../../../../../../../../Desktop/Proje%20Klos%C3%B6r%C3%BC/React/flagship/apps/dashboard/lib/webhooks.ts"],"sourcesContent":["import { db } from './firebase';\r\nimport { collection, addDoc, serverTimestamp } from 'firebase/firestore';\r\n\r\n// Webhook types\r\nexport type WebhookEvent = \r\n  | 'flag.created'\r\n  | 'flag.updated' \r\n  | 'flag.deleted'\r\n  | 'flag.toggled'\r\n  | 'targeting.updated';\r\n\r\nexport type WebhookProvider = 'slack' | 'discord' | 'custom';\r\n\r\nexport interface Webhook {\r\n  id: string;\r\n  projectId: string;\r\n  name: string;\r\n  url: string;\r\n  provider: WebhookProvider;\r\n  events: WebhookEvent[];\r\n  enabled: boolean;\r\n  secret?: string;\r\n  headers?: Record<string, string>;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  lastTriggeredAt?: Date;\r\n}\r\n\r\nexport interface WebhookPayload {\r\n  event: WebhookEvent;\r\n  timestamp: string;\r\n  projectId: string;\r\n  data: {\r\n    flagKey?: string;\r\n    flagName?: string;\r\n    action: string;\r\n    actor: string;\r\n    changes?: any;\r\n    before?: any;\r\n    after?: any;\r\n  };\r\n}\r\n\r\nexport interface WebhookDelivery {\r\n  id: string;\r\n  webhookId: string;\r\n  event: WebhookEvent;\r\n  payload: WebhookPayload;\r\n  status: 'success' | 'failed' | 'pending';\r\n  statusCode?: number;\r\n  response?: string;\r\n  error?: string;\r\n  attemptCount: number;\r\n  deliveredAt?: Date;\r\n  createdAt: Date;\r\n}\r\n\r\n// Format payload for different providers\r\nexport function formatWebhookPayload(\r\n  webhook: Webhook,\r\n  payload: WebhookPayload\r\n): any {\r\n  switch (webhook.provider) {\r\n    case 'slack':\r\n      return formatSlackPayload(payload);\r\n    case 'discord':\r\n      return formatDiscordPayload(payload);\r\n    case 'custom':\r\n    default:\r\n      return payload;\r\n  }\r\n}\r\n\r\n// Slack message format\r\nfunction formatSlackPayload(payload: WebhookPayload): any {\r\n  const { event, data, timestamp } = payload;\r\n  \r\n  const emoji = getEventEmoji(event);\r\n  const color = getEventColor(event);\r\n  \r\n  return {\r\n    text: `${emoji} Feature Flag Event: ${event}`,\r\n    attachments: [\r\n      {\r\n        color: color,\r\n        fields: [\r\n          {\r\n            title: 'Event',\r\n            value: event,\r\n            short: true,\r\n          },\r\n          {\r\n            title: 'Flag',\r\n            value: data.flagKey || 'N/A',\r\n            short: true,\r\n          },\r\n          {\r\n            title: 'Action',\r\n            value: data.action,\r\n            short: true,\r\n          },\r\n          {\r\n            title: 'Actor',\r\n            value: data.actor || 'System',\r\n            short: true,\r\n          },\r\n          ...(data.changes ? [{\r\n            title: 'Changes',\r\n            value: `\\`\\`\\`${JSON.stringify(data.changes, null, 2)}\\`\\`\\``,\r\n            short: false,\r\n          }] : []),\r\n        ],\r\n        footer: 'Flagship Feature Flags',\r\n        ts: new Date(timestamp).getTime() / 1000,\r\n      },\r\n    ],\r\n  };\r\n}\r\n\r\n// Discord message format\r\nfunction formatDiscordPayload(payload: WebhookPayload): any {\r\n  const { event, data, timestamp } = payload;\r\n  \r\n  const emoji = getEventEmoji(event);\r\n  const color = getEventColorHex(event);\r\n  \r\n  return {\r\n    content: `${emoji} **Feature Flag Event:** ${event}`,\r\n    embeds: [\r\n      {\r\n        color: color,\r\n        fields: [\r\n          {\r\n            name: 'Event',\r\n            value: event,\r\n            inline: true,\r\n          },\r\n          {\r\n            name: 'Flag',\r\n            value: data.flagKey || 'N/A',\r\n            inline: true,\r\n          },\r\n          {\r\n            name: 'Action',\r\n            value: data.action,\r\n            inline: true,\r\n          },\r\n          {\r\n            name: 'Actor',\r\n            value: data.actor || 'System',\r\n            inline: true,\r\n          },\r\n          ...(data.changes ? [{\r\n            name: 'Changes',\r\n            value: `\\`\\`\\`json\\n${JSON.stringify(data.changes, null, 2)}\\n\\`\\`\\``,\r\n            inline: false,\r\n          }] : []),\r\n        ],\r\n        footer: {\r\n          text: 'Flagship Feature Flags',\r\n        },\r\n        timestamp: timestamp,\r\n      },\r\n    ],\r\n  };\r\n}\r\n\r\n// Helper functions\r\nfunction getEventEmoji(event: WebhookEvent): string {\r\n  switch (event) {\r\n    case 'flag.created': return 'üéâ';\r\n    case 'flag.updated': return '‚úèÔ∏è';\r\n    case 'flag.deleted': return 'üóëÔ∏è';\r\n    case 'flag.toggled': return 'üîÑ';\r\n    case 'targeting.updated': return 'üéØ';\r\n    default: return 'üì¢';\r\n  }\r\n}\r\n\r\nfunction getEventColor(event: WebhookEvent): string {\r\n  switch (event) {\r\n    case 'flag.created': return 'good';\r\n    case 'flag.updated': return 'warning';\r\n    case 'flag.deleted': return 'danger';\r\n    case 'flag.toggled': return '#36a64f';\r\n    case 'targeting.updated': return '#439FE0';\r\n    default: return '#808080';\r\n  }\r\n}\r\n\r\nfunction getEventColorHex(event: WebhookEvent): number {\r\n  switch (event) {\r\n    case 'flag.created': return 0x36a64f; // Green\r\n    case 'flag.updated': return 0xff9800; // Orange\r\n    case 'flag.deleted': return 0xf44336; // Red\r\n    case 'flag.toggled': return 0x2196f3; // Blue\r\n    case 'targeting.updated': return 0x9c27b0; // Purple\r\n    default: return 0x808080; // Gray\r\n  }\r\n}\r\n\r\n// Send webhook\r\nexport async function sendWebhook(\r\n  webhook: Webhook,\r\n  payload: WebhookPayload\r\n): Promise<{ success: boolean; statusCode?: number; error?: string }> {\r\n  if (!webhook.enabled) {\r\n    return { success: false, error: 'Webhook is disabled' };\r\n  }\r\n\r\n  try {\r\n    const formattedPayload = formatWebhookPayload(webhook, payload);\r\n    \r\n    const headers: Record<string, string> = {\r\n      'Content-Type': 'application/json',\r\n      'User-Agent': 'Flagship-Webhooks/1.0',\r\n      ...(webhook.headers || {}),\r\n    };\r\n\r\n    // Add signature if secret is provided\r\n    if (webhook.secret) {\r\n      const signature = await generateSignature(\r\n        JSON.stringify(formattedPayload),\r\n        webhook.secret\r\n      );\r\n      headers['X-Flagship-Signature'] = signature;\r\n    }\r\n\r\n    const response = await fetch(webhook.url, {\r\n      method: 'POST',\r\n      headers,\r\n      body: JSON.stringify(formattedPayload),\r\n      signal: AbortSignal.timeout(10000), // 10s timeout\r\n    });\r\n\r\n    const success = response.ok;\r\n    const statusCode = response.status;\r\n\r\n    // Log delivery\r\n    await logWebhookDelivery({\r\n      webhookId: webhook.id,\r\n      event: payload.event,\r\n      payload,\r\n      status: success ? 'success' : 'failed',\r\n      statusCode,\r\n      response: success ? await response.text() : undefined,\r\n      error: success ? undefined : `HTTP ${statusCode}: ${response.statusText}`,\r\n      attemptCount: 1,\r\n    });\r\n\r\n    return { success, statusCode };\r\n  } catch (error: any) {\r\n    // Log failed delivery\r\n    await logWebhookDelivery({\r\n      webhookId: webhook.id,\r\n      event: payload.event,\r\n      payload,\r\n      status: 'failed',\r\n      error: error.message,\r\n      attemptCount: 1,\r\n    });\r\n\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\n// Generate HMAC signature\r\nasync function generateSignature(payload: string, secret: string): Promise<string> {\r\n  const encoder = new TextEncoder();\r\n  const data = encoder.encode(payload);\r\n  const key = encoder.encode(secret);\r\n\r\n  // Import key for HMAC\r\n  const cryptoKey = await crypto.subtle.importKey(\r\n    'raw',\r\n    key,\r\n    { name: 'HMAC', hash: 'SHA-256' },\r\n    false,\r\n    ['sign']\r\n  );\r\n\r\n  // Generate signature\r\n  const signature = await crypto.subtle.sign('HMAC', cryptoKey, data);\r\n\r\n  // Convert to hex\r\n  return Array.from(new Uint8Array(signature))\r\n    .map(b => b.toString(16).padStart(2, '0'))\r\n    .join('');\r\n}\r\n\r\n// Log webhook delivery\r\nasync function logWebhookDelivery(\r\n  delivery: Omit<WebhookDelivery, 'id' | 'createdAt' | 'deliveredAt'>\r\n): Promise<void> {\r\n  try {\r\n    await addDoc(collection(db, 'webhook_deliveries'), {\r\n      ...delivery,\r\n      createdAt: serverTimestamp(),\r\n      deliveredAt: delivery.status === 'success' ? serverTimestamp() : null,\r\n    });\r\n  } catch (error) {\r\n    console.error('Failed to log webhook delivery:', error);\r\n  }\r\n}\r\n\r\n// Trigger webhooks for an event\r\nexport async function triggerWebhooks(\r\n  projectId: string,\r\n  event: WebhookEvent,\r\n  data: WebhookPayload['data']\r\n): Promise<void> {\r\n  const { collection: firestoreCollection, query, where, getDocs } = await import('firebase/firestore');\r\n  \r\n  try {\r\n    // Get all enabled webhooks for this project that listen to this event\r\n    const webhooksQuery = query(\r\n      firestoreCollection(db, 'webhooks'),\r\n      where('projectId', '==', projectId),\r\n      where('enabled', '==', true),\r\n      where('events', 'array-contains', event)\r\n    );\r\n\r\n    const webhooksSnapshot = await getDocs(webhooksQuery);\r\n\r\n    if (webhooksSnapshot.empty) {\r\n      return;\r\n    }\r\n\r\n    const payload: WebhookPayload = {\r\n      event,\r\n      timestamp: new Date().toISOString(),\r\n      projectId,\r\n      data,\r\n    };\r\n\r\n    // Send to all matching webhooks (in parallel)\r\n    const promises = webhooksSnapshot.docs.map(doc => {\r\n      const webhook = { id: doc.id, ...doc.data() } as Webhook;\r\n      return sendWebhook(webhook, payload);\r\n    });\r\n\r\n    await Promise.allSettled(promises);\r\n  } catch (error) {\r\n    console.error('Failed to trigger webhooks:', error);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}